<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Expense Tracker</title>
    <link rel="stylesheet" href="/styles/dashb.css" />
  </head>
  <body>
    <!-- Header -->
    <header class="dashboard-header">
      <h1>üí∞ Expense Tracker</h1>
      <div class="budget-display">
        <h2>Budget: ‚Ç±<%= budget || 0 %></h2>
        <button id="set-budget-btn">üíµ Set Budget</button>
      </div>
    </header>

    <!-- Categories Section -->
    <section class="categories">
      <div class="categories-header">
        <h2>Categories</h2>
        <div class="action-buttons">
          <button class="add-btn">Ôºã Add</button>
          <button class="delete-btn">üóëÔ∏è Delete</button>
        </div>
      </div>

      <div class="cards">
        <% categories.forEach(category => { %>
        <button
          class="category-button <%= selectedCategory && selectedCategory.categoryid === category.categoryid ? 'active' : '' %>"
        >
          <a href="/dashboard?categoryId=<%= category.categoryid %>">
            <%= category.name.toUpperCase() %>
          </a>
        </button>
        <% }) %>
      </div>
    </section>

    <!-- Expenses Section -->
    <section class="expenses">
      <% if (selectedCategory) { %>
      <div class="expense-category">
        <h3><%= selectedCategory.name %> Expenses</h3>

        <button class="add-expense-btn">‚ûï Add Expense</button>

        <ul>
          <% if (expenses.length > 0) { %> <% expenses.forEach(exp => { %>
          <li>
            <%= exp.description %> ‚Äî ‚Ç±<%= exp.amount %>
            <span
              style="cursor: pointer"
              onclick="deleteExpense(<%= exp.expenseid %>)"
              >üóëÔ∏è</span
            >
          </li>
          <% }) %> <% } else { %>
          <li>No expenses yet for this category.</li>
          <% } %>
        </ul>
      </div>
      <% } else { %>
      <p class="empty-message">Select a category to view its expenses.</p>
      <% } %>
    </section>
  </body>

  <script>
    // üíµ SET or UPDATE BUDGET
    const setBudgetBtn = document.getElementById("set-budget-btn");

    setBudgetBtn.addEventListener("click", async () => {
      const amount = prompt("Enter your total budget (‚Ç±):");
      if (!amount || isNaN(amount) || amount <= 0) {
        alert("‚ö†Ô∏è Please enter a valid positive number.");
        return;
      }

      try {
        const res = await fetch("/budget", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ amount: parseFloat(amount) }),
        });

        if (res.ok) {
          alert("‚úÖ Budget updated!");
          window.location.reload();
        } else {
          const data = await res.json();
          alert("‚ùå " + (data.error || "Failed to update budget"));
        }
      } catch (err) {
        alert("‚ö†Ô∏è Network error: " + err.message);
      }
    });

    document.addEventListener("DOMContentLoaded", () => {
      const addBtn = document.querySelector(".add-btn");
      const deleteBtn = document.querySelector(".delete-btn");
      const categoryButtons = document.querySelectorAll(".category-button a");

      // Get the currently selected category from the server-rendered EJS variable
      const selectedCategoryId =
        "<%= selectedCategory ? selectedCategory.categoryid : '' %>";

      // üîπ Highlight selected category (optional visual effect)
      categoryButtons.forEach((btn) => {
        if (btn.href.includes(`categoryId=${selectedCategoryId}`)) {
          btn.parentElement.classList.add("active");
        }
      });

      // ‚ûï ADD CATEGORY
      addBtn.addEventListener("click", async () => {
        const name = prompt("Enter new category name:");
        if (!name) return;

        try {
          const res = await fetch("/category", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name }),
          });

          if (res.ok) {
            alert("‚úÖ Category added!");
            window.location.reload();
          } else {
            const data = await res.json();
            alert("‚ùå " + (data.error || "Failed to add category"));
          }
        } catch (err) {
          alert("‚ö†Ô∏è Network error: " + err.message);
        }
      });

      // üóëÔ∏è DELETE SELECTED CATEGORY
      deleteBtn.addEventListener("click", async () => {
        if (!selectedCategoryId) {
          alert("‚ö†Ô∏è Please select a category first before deleting!");
          return;
        }

        if (!confirm("Are you sure you want to delete this category?")) return;

        try {
          const res = await fetch(`/category/${selectedCategoryId}`, {
            method: "DELETE",
          });

          if (res.ok) {
            alert("üóëÔ∏è Category deleted!");
            window.location.href = "/dashboard"; // Reload dashboard without selected category
          } else {
            const data = await res.json();
            alert("‚ùå " + (data.error || "Failed to delete category"));
          }
        } catch (err) {
          alert("‚ö†Ô∏è Network error: " + err.message);
        }
      });
    });

    // ‚ûï ADD EXPENSE
    const addExpenseBtn = document.querySelector(".add-expense-btn");
    if (addExpenseBtn) {
      addExpenseBtn.addEventListener("click", async () => {
        const description = prompt("Enter expense description:");
        if (!description) return;

        const amount = prompt("Enter expense amount (‚Ç±):");
        if (!amount || isNaN(amount) || amount <= 0) {
          alert("‚ö†Ô∏è Please enter a valid amount.");
          return;
        }

        const selectedCategoryId =
          "<%= selectedCategory ? selectedCategory.categoryid : '' %>";
        if (!selectedCategoryId) {
          alert("‚ö†Ô∏è Please select a category first.");
          return;
        }

        try {
          const res = await fetch("/expense", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              description,
              amount: parseFloat(amount),
              categoryid: selectedCategoryId,
            }),
          });

          if (res.ok) {
            alert("‚úÖ Expense added!");
            window.location.reload();
          } else {
            const data = await res.json();
            alert("‚ùå " + (data.error || "Failed to add expense"));
          }
        } catch (err) {
          alert("‚ö†Ô∏è Network error: " + err.message);
        }
      });
    }

    async function deleteExpense(expenseId) {
      const result = await fetch(`/expense/${expenseId}`, {
        method: "DELETE",
      });

      if (result.ok) {
        alert("Expense deleted!");
        window.location.reload();
      } else {
        alert("Failed to delete expense.");
      }
    }
  </script>
</html>
